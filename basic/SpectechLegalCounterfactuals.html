<html>
    <head>
      <!--<meta name="google-site-verification" content="Z7SEnQaO9LAITbhuwGaI3rFtnpMRKeV9BbaW3LyvP2g" />-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="revised" content="18 April 2022" />
        <title>Drill down: A. Specialists and technicians - Counterfactuals for a collapsed set of occupations</title>

        <!--<link rel="stylesheet" href="https://latex.now.sh/style.css"> -->
        <link rel="stylesheet" href="https://alanintsukuba.github.io/latex.css">
        <link rel="stylesheet" href="https://alanintsukuba.github.io/ShowReferencesModal.css"> 
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" 
integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" 
integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]-->    
</head>
<body>
<h1>Drill down: A. Specialists and technicians - Counterfactuals for a collapsed set of occupations</h1>
<p class="author"><a href="https://orcid.org/0000-0003-0070-2347" target="_blank">Alan Engel</a><br>Last update: 
    18 April 2022</p>
<article>
    <p>Elbers (2021) illustrates decompositions of the changes in M. He first decomposes changes into structural changes 
        and marginal changes. He then further decomposes the marginal changes into those due to changes in occupations and those due to 
        changes in gender. He further decomposes structural changes by occupation. Here I apply these decompositions to this task 
        using the data in Table 1. Table 1 shows the gender frequencies also shown in Table 1 of the <a href="EstimatingCounterfactuals.html">previous page on 
            estimating counterfactuals</a>. The counterfactual values are from Table 2 of that page.
    </p>
    <table class="noincrement" style="counter-increment: null;">
        <caption class="noincrement"><b>Table 1.</b> Actual occupation vs gender frequencies for legal occupations in 1985 and 2005 with 
        counterfactuals</caption>
        <tr><th></th><th colspan=3>1985</th><th></th><th colspan=3>2005</th></tr>
        <tr><td></td><td colspan=2>Gender</td><td></td><td></td><td colspan=2>Gender</td></tr>
        <tr><td>Occupation</td><td>Female</td><td>Male</td><td>Marginal total</td><td></td><td>Female</td><td>Male</td><td>Marginal total</td></tr>
        <tr><td>Judges, lawyers</td><td>789</td><td>15204</td><td>15993</td><td></td><td>2302</td><td>19506</td><td>21808</td></tr>
        <tr><td>Other legal</td><td>2795</td><td>23926</td><td>26721</td><td></td><td>6379</td><td>29833</td><td>36212</td></tr>
        <tr><td>Other spectech</td><td>2555759</td><td>3789332</td><td>6345091</td><td></td><td>4018698</td><td>4465215</td><td>8483913</td></tr>
        <tr><td>Marginal total</td><td>2559343</td><td>3828462</td><td>6387805</td><td></td><td>4027379</td><td>4514554</td><td>8541933</td></tr>
        <tr><th></th><th colspan=7>Counterfactuals</th></tr>
        <tr><th></th><th colspan=3>least squares regression (Deming and Stephan, 1940)</th><th></th><th colspan=3>iterative proportional fitting (Elber, 2021)</th></tr>
        <tr><td></td><td colspan=2>Gender</td><td></td><td></td><td colspan=2>Gender</td></tr>
        <tr><td>Occupation</td><td>Female</td><td>Male</td><td>Marginal total</td><td></td><td>Female</td><td>Male</td><td>Marginal total</td></tr>
        <tr><td>Judges, lawyers</td><td>1302</td><td>20506</td><td>21808</td><td></td><td>1057</td><td>15244</td><td>16301</td></tr>
        <tr><td>Other legal</td><td>4541</td><td>31671</td><td>36212</td><td></td><td>3654</td><td>23416</td><td>27070</td></tr>
        <tr><td>Other spectech</td><td>3876555</td><td>4607358</td><td>8483913</td><td></td><td>3007033</td><td>3337401</td><td>6344434</td></tr>
        <tr><td>Marginal total</td><td>4027379</td><td>4514554</td><td>8541933</td><td></td><td>3011744</td><td>3376061</td><td>6387805</td></tr>
    </table>
    <p>The first decomposition of the change in M between two times \(t_{1}\) and \(t_{2}\) as shown in 
        Equation (1), where \(M(t'_{1}\) is the value of M calculated using the counterfactuals at time \(t_{2}\) versus \(t_{1}\). 
        $$\tag{1} M(t_{2})-M(t_{1})=\overbrace{M(t_{2})-M(t_{1'})}^{\text{structural}}+\overbrace{M(t_{1'})-M(t_{1})}^{\text{marginal}} $$
        Referring to the <a href="OccupationGenderWalkthrough01.html">earlier walkthrough</a>, I rewrite Table 1, replacing counts 
        with percentages of the total sample.
    </p>
    <table class="noincrement" style="counter-increment: null;">
        <caption class="noincrement"><b>Table 2.</b> Actual occupation vs gender probabilities for legal occupations in 1985 and 2005 with 
        counterfactuals</caption>
        <tr><th></th><th colspan=3>1985</th><th></th><th colspan=3>2005</th></tr>
        <tr><td></td><td colspan=2>Gender</td><td></td><td></td><td colspan=2>Gender</td></tr>
        <tr><td>Occupation</td><td>Female</td><td>Male</td><td>Marginal</td><td></td><td>Female</td><td>Male</td><td>Marginal</td></tr>
        <tr><td>Judges, lawyers</td><td>0.0124%</td><td>0.238%</td><td>0.250%</td><td></td><td>0.0269%</td><td>0.228%</td><td>0.255%</td></tr>
        <tr><td>Other legal</td><td>0.0438</td><td>0.375</td><td>0.418</td><td></td><td>0.0748</td><td>0.349</td><td>0.424</td></tr>
        <tr><td>Other spectech</td><td>40.01</td><td>59.32</td><td>99.33</td><td></td><td>47.05</td><td>52.27</td><td>99.32</td></tr>
        <tr><td>Marginal</td><td>40.07</td><td>59.93</td><td>100</td><td></td><td>47.15</td><td>52.85</td><td>100</td></tr>
        <tr><th></th><th colspan=7>Counterfactuals</th></tr>
        <tr><th></th><th colspan=3>least squares regression (Deming and Stephan, 1940)</th><th></th><th colspan=3>iterative proportional fitting (Elber, 2021)</th></tr>
        <tr><td></td><td colspan=2>Gender</td><td></td><td></td><td colspan=2>Gender</td></tr>
        <tr><td>Occupation</td><td>Female</td><td>Male</td><td>Marginal</td><td></td><td>Female</td><td>Male</td><td>Marginal</td></tr>
        <tr><td>Judges, lawyers</td><td>0.0152%</td><td>0.240%</td><td>0.255%</td><td></td><td>0.0165%</td><td>0.237%</td><td>0.255%</td></tr>
        <tr><td>Other legal</td><td>0.0532</td><td>0.371</td><td>0.424</td><td></td><td>0.0572</td><td>0.367</td><td>0.424</td></tr>
        <tr><td>Other spectech</td><td>45.39</td><td>53.94</td><td>99.32</td><td></td><td>47.07</td><td>52.25</td><td>99.32</td></tr>
        <tr><td>Marginal</td><td>47.15</td><td>52.85</td><td>100</td><td></td><td>47.15</td><td>52.85</td><td>100</td></tr>
    </table>
    <p>Working from the counts in Table 1 to reduce rounding errors, we get 
        $$ \begin{align}
        M_{2005} & = 0.00163 \\
        \tag{2}M_{1985'} & = 0.00208 \\
        M_{1985} & = 0.00176 
        \end{align}. $$
        This gives</p>
    <table class="noborder">
        <tr><td>\(\Delta_{total}\)</td><td>\(M_{2005}-M_{1985}\)</td><td>\(=\)</td><td>\(-0.000142\)</td><td>\(=> -8.1 \text{% change}\)</td><td></td></tr>
        <tr><td>\(\Delta_{structural}\)</td><td>\(M_{2005}-M_{1985'}\)</td><td>\(=\)</td><td>\(-0.000452\)</td><td>\(=> -25.6 \text{%}\)</td><td>\(\tag{3}\)</td></tr>
        <tr><td>\(\Delta_{marginal}\)</td><td>\(M_{1985'}-M_{1985}\)</td><td>\(=\)</td><td>\(0.000311\)</td><td>\(=> 17.6 \text{%}\)</td></tr>
    </table>
    <p>which shows a 18 % increase in M due to marginal changes being offset by a 26 % decrease due to structural changes.</p>
</article>
<article>
    <h4>Comparison to Elber's decomposition</h4>
    <p>Segregation computations for the this compressed dataset are contained in <a href="R/SpectechLegalMIndex.R">supplemental R code</a>. Relevant 
    extracts are shown below.</p>
    <h5>Decomposition of the change in M into structural and marginal components.</h5>
    <p>The segregation package's ipf function calculates a set of counterfactuals using the iterative proportional fitting 
        algorithm also introduced in Deming and Stephan (1940). In the R console output shown below, n_source is the 1985 data and n_target 
        is the 2005 data. The resulting counterfactual counts are in Table 1 and the probabilities are in Table 2. The least squares method here shows 
        the marginal counts of the 2005 data. Elber's IPF adjusts the values so that the number of observations is the same as for 1985. 
        Both methods produce the same probabilities.
    </p>
<pre><code class="language-html"># counterfactuals using ipf function
(cfacts <- ipf(legal1985, legal2005, "Gender", "OccMinor", weight = "w"))
## [IPF 1/1] #
##              
##   Gender OccMinor n_source n_target           n
## 1 FEMALE     1028      789     2302    1056.823
## 2 FEMALE     1029     2795     6379    3654.223
## 3 FEMALE     1999  2555759  4018698 3007032.515
## 4   MALE     1028    15204    19506   15244.417
## 5   MALE     1029    23926    29833   23415.900
## 6   MALE     1999  3789332  4465215 3337401.121
</code></pre>
<p>The function mutual_difference provides \(M_{1985}\)(M1) and  \(M_{2005}\)(M2). It doesn't provide 
    \(M_{1985'}\) directly, but we can get this by summing M1, group_marginal and unit_marginal. 
    $$ \begin{align}
    M_{2005} & = 0.00163 \\
    \tag{4}M_{1985'} & = 0.00189 \\
    M_{1985} & = 0.00176 
    \end{align}. $$
    This gives</p>
<table class="noborder">
    <tr><td>\(\Delta_{total}\)</td><td>\(M_{2005}-M_{1985}\)</td><td>\(=\)</td><td>\(-0.000142\)</td><td>\(=> -8.1 \text{% change}\)</td><td></td></tr>
    <tr><td>\(\Delta_{structural}\)</td><td>\(M_{2005}-M_{1985'}\)</td><td>\(=\)</td><td>\(-0.000266\)</td><td>\(=> -15.0 \text{%}\)</td><td>\(\tag{5}\)</td></tr>
    <tr><td>\(\Delta_{marginal}\)</td><td>\(M_{1985'}-M_{1985}\)</td><td>\(=\)</td><td>\(0.000124\)</td><td>\(=> 7.0 \text{%}\)</td></tr>
</table>
<p>which shows a 7.0 % increase in M due to marginal changes being offset by a 15.0 % decrease due to structural changes. 
    The \(\Delta_{structural}\) and \(\Delta_{marginal}\) 
    estimated for the least squares counterfactuals fall inside the confidence intervals estimated by the IPF method (see code below). The 
    function \(mutual_difference\) further decomposes marginal changes into group (gender) and unit (occupation) contributions. The total 
    marginal component is simply the sum of these two.
</p>
<pre><code class="language-html"># Decomposing changes in indices
mutual_difference(legal1985, legal2005, "Gender", "OccMinor", weight = "w")
            
##              stat           est
## 1:             M1  1.764758e-03
## 2:             M2  1.622900e-03
## 3:           diff -1.418572e-04
## 4:      additions  0.000000e+00
## 5:       removals  0.000000e+00
## 6: group_marginal  1.175015e-04
## 7:  unit_marginal  6.226171e-06
## 8:     structural -2.655849e-04

mutual_difference(legal1985, legal2005, "Gender", "OccMinor", weight = "w", se=TRUE)

##             stat           est           se                          CI          bias
## 1:             M1  0.0017647425 2.070748e-05     0.001722991,0.001802110  1.513961e-08
## 2:             M2  0.0016236760 2.014460e-05     0.001582224,0.001654201 -7.755737e-07
## 3:           diff -0.0001410665 3.096467e-05 -1.988926e-04,-7.613107e-05 -7.907133e-07
## 4:      additions  0.0000000000 0.000000e+00                         0,0  0.000000e+00
## 5:       removals  0.0000000000 0.000000e+00                         0,0  0.000000e+00
## 6: group_marginal  0.0001027409 6.368765e-06   0.0000945652,0.0001153312  7.086803e-06
## 7:  unit_marginal  0.0000209698 6.467000e-06   7.527389e-06,2.779999e-05 -7.069809e-06
## 8:     structural -0.0002647772 3.115294e-05 -0.0003221377,-0.0001986830 -8.077073e-07
</code></pre>
<p>Because M is dependent on the number of occupations, calculations of M for this collapsed set can't be readily compared to 
    the full set. The next page continues analysis of local segregation for the full set of spectech occupations.
</p>
</article>
<!--
<article>
    <h4>Local segregation</h4>
<p>The structural changes in M are the sum of the structural changes in the units, in this case the occupations.
    $$\begin{align} \Delta_{structural} & = \frac{1}{2}(M(t_{2})-M(t'_{1})) + \frac{1}{2}(M(t'_{2})-M(t_{1})) \\ 
    & =\sum_{u=1}^{U}\left(\frac{1}{2}p_{.u}^{t_{2}}[L_{u}(t_{2})-L_{u}(t'_{1})]+\frac{1}{2}p_{.u}^{t_{1}}[L_{u}(t'_{2})-L_{u}(t_{1})]  \right)   \\
    & =\sum_{u=1}^{U}\Delta_{u,structural} 
    \end{align} $$ Elber's (2018) decomposition allows further 
    decompositions based on local segregation scores, holding the marginals constant. 
    The function \( mutual\_local \) shown in the code below gives the local segregation scores \(L_{u}\) and marginal weights \(p_{u.}\), where 
    the local segregation score of unit \(u\) is defined as
    $$ L_{u} = \sum_{g=1}^{G}p_{g|u}\log{\frac{p_{g|u}}{p_{.g}}} $$ with \(p_{g|u}=t_{ug}/t_{u.}\). In addition to the counterfactuals for 
    \(t'_{1}\), this decomposition uses the counterfactuals for \(t'_{2}\). These can be calculated using the \(ipf\) function.
</p>
<pre><code class="language-html">## counterfactuals for both directions
(legal1985cf <- ipf(legal1985, legal2005, "Gender", "OccMinor", weight = "w", precision=1e-7) %>% 
    mutate(w = n) %>%
    select(Gender,OccMinor,w))
##   Gender OccMinor           w
## 1 FEMALE     1028    1057.290
## 2 FEMALE     1029    3655.558
## 3 FEMALE     1999 3007030.713
## 4   MALE     1028   15251.083
## 5   MALE     1029   23424.365
## 6   MALE     1999 3337385.991

(legal2005cf <- ipf(legal2005, legal1985, "Gender", "OccMinor", weight = "w", precision=1e-7) %>% 
    mutate(w = n) %>%
    select(Gender,OccMinor,w))
##   Gender OccMinor           w
## 1 FEMALE     1028    1736.260
## 2 FEMALE     1029    4931.009
## 3 FEMALE     1999 3415750.357
## 4   MALE     1028   19649.994
## 5   MALE     1029   30801.001
## 6   MALE     1999 5069064.378
</code></pre>
<p>Then calculate the local segregation scores for each occupation and time with respective counterfactual.</p>
<pre><code class="language-html">
(localseg1985 <- mutual_local(legal1985, "Gender", "OccMinor", weight = "w", wide = TRUE))
##    OccMinor           ls           p
## 1:     1028 3.352452e-01 0.002503677
## 2:     1029 2.189781e-01 0.004183127
## 3:     1999 9.461832e-06 0.993313196

(localseg1985cf <- mutual_local(legal1985cf, "Gender", "OccMinor", weight = "w", wide = TRUE))
##   OccMinor           ls           p
## 1:     1028 4.050255e-01 0.002553048
## 2:     1029 2.573294e-01 0.004239316
## 3:     1999 1.235412e-05 0.993207636

(localseg2005cf <- mutual_local(legal2005cf, "Gender", "OccMinor", weight = "w", wide = TRUE))
##    OccMinor           ls           p
## 1:     1028 2.629661e-01 0.002503679
## 2:     1029 1.661860e-01 0.004183129
## 3:     1999 7.603102e-06 0.993313192

(localseg2005 <- mutual_local(legal2005, "Gender", "OccMinor", weight = "w", wide = TRUE))
##    OccMinor           ls           p
## 1:     1028 3.126092e-01 0.002553052
## 2:     1029 1.922804e-01 0.004239321
## 3:     1999 9.720246e-06 0.993207626
</code></pre>
<table class="noincrement" style="counter-increment: null;">
    <caption class="noincrement">Decomposition of structural changes into contributions of the occupations</caption>
    <tr><th>Occupation</th><th colspan=2>Proportion</th><th colspan=2>Observed</th><th colspan=2>Counterfactual</th><th style="text-align: right">Weighted difference</th></tr>
    <tr><td style="text-align: right">\(u \)</td>
        <td>\(p_{.u}^{t_{1}} \)</td>
        <td>\(p_{.u}^{t_{2}} \)</td>
        <td>\(L_{u}(t_{1}) \)</td>
        <td>\(L_{u}(t_{2}) \)</td>
        <td>\(L_{u}(t'_{2}) \)</td>
        <td>\(L_{u}(t'_{1}) \)</td>
        <td style="text-align: right">\(\Delta_{u,structural} \)</td></tr>
    <tr><td style="text-align: right">Judges, lawyers</td>
        <td>0.0025</td><td>0.0026</td><td>0.335</td><td>0.313</td><td>0.263</td><td>0.405</td>
        <td style="text-align: right;">1.51e-04</td></tr>
    <tr><td style="text-align: right">Other legal</td>
        <td>0.0042</td><td>0.0042</td><td>0.219</td><td>0.192</td><td>0.166</td><td>0.257</td>
        <td style="text-align: right;">1.36e-04</td></tr>
    <tr><td style="text-align: right">Other spectech</td>
        <td>0.9933</td><td>0.9932</td><td>9.46e-06</td><td>9.72e-06</td><td>7.60e-06</td><td>1.24e-05</td>
        <td style="text-align: right;">2.49e-06</td></tr>
    </table>
<pre><code class="language-html">#########################################################
## Decomposition of structural changes into contributions of each occupation
localchange <- data.table(localseg1985[,"OccMinor"], p1 = localseg1985[,"p"], 
    p2 = localseg2005[,"p"], ls1=localseg1985[,"ls"],ls2=localseg2005[,"ls"],
    ls2cf=localseg2005cf[,"ls"],ls1cf=localseg1985cf[,"ls"])

localchange <- setnames(localchange,c("OccMinor","p1","p2","ls1","ls2","ls2cf","ls1cf")) %>% 
    mutate(wd = (p2*(ls2-ls2cf) + p1*(ls1cf-ls1))/2)

localchange 
##    OccMinor          p1          p2          ls1          ls2        ls2cf        ls1cf           wd
## 1:     1028 0.002503677 0.002553052 3.352452e-01 3.126092e-01 2.629661e-01 4.050255e-01 1.507244e-04
## 2:     1029 0.004183127 0.004239321 2.189781e-01 1.922804e-01 1.661860e-01 2.573294e-01 1.355255e-04
## 3:     1999 0.993313196 0.993207626 9.461832e-06 9.720246e-06 7.603102e-06 1.235412e-05 2.487857e-06

print(localchange, digits=3)
    OccMinor      p1      p2      ls1      ls2    ls2cf    ls1cf       wd
## 1:     1028 0.00250 0.00255 3.35e-01 3.13e-01 2.63e-01 4.05e-01 1.51e-04
## 2:     1029 0.00418 0.00424 2.19e-01 1.92e-01 1.66e-01 2.57e-01 1.36e-04
## 3:     1999 0.99331 0.99321 9.46e-06 9.72e-06 7.60e-06 1.24e-05 2.49e-06
    
</code></pre>
<pre><code class="language-html">##########################################################
## local segregation

mutual_local(legal1985, "Gender", "OccMinor", weight = "w", 
    wide = TRUE, se = TRUE, CI = .95, n_bootstrap = 500)

## 500 bootstrap iterations on 6387805 observations
##   OccMinor           ls        ls_se                     ls_CI       ls_bias           p         p_se                    p_CI        p_bias
## 1:     1028 3.353249e-01 4.509297e-03       0.3272385,0.3440315 -7.970815e-05 0.002503730 2.006284e-05 0.002466782,0.002544254 -5.260023e-08
## 2:     1029 2.190133e-01 3.403324e-03       0.2122004,0.2257648 -3.511488e-05 0.004182378 2.576516e-05 0.004129572,0.004233148  7.489271e-07
## 3:     1999 9.461750e-06 1.227055e-07 9.222291e-06,9.703226e-06  8.205336e-11 0.993313892 3.327408e-05     0.9932447,0.9933803 -6.963268e-07

mutual_local(legal2005, "Gender", "OccMinor", weight = "w", 
    wide = TRUE, se = TRUE, CI = .95, n_bootstrap = 500)

## 500 bootstrap iterations on 8541933 observations
##    OccMinor           ls        ls_se                     ls_CI       ls_bias           p         p_se                    p_CI        p_bias
## 1:     1028 3.127103e-01 4.149638e-03       0.3049829,0.3209711 -1.011267e-04 0.002552984 1.747530e-05 0.002519854,0.002589774  6.813446e-08
## 2:     1029 1.925077e-01 2.840052e-03       0.1874197,0.1977822 -2.273009e-04 0.004239439 2.288586e-05 0.004196998,0.004283357 -1.180061e-07
## 3:     1999 9.727760e-06 1.195276e-07 9.495809e-06,9.970365e-06 -7.513348e-09 0.993207577 2.773202e-05     0.9931544,0.9932600  4.987162e-08

</code></pre>
</article>
-->
<div id="references" class="section level2">
    <h2 class="hasAnchor">
    <a href="#references" class="anchor"></a>References</h2>
    <p><a id="Elbers2021"></a>Elbers, Benjamin (2021). A Method for Studying Differences in Segregation Across Time and Space. 
        Sociological Methods &amp; Research. <a href="https://doi.org/10.1177/0049124121986204" 
        class="uri">doi:10.18637/jss.v089.i07</a></p>
    <p><a id="KarmelMaclachlan1988"></a>Karmel, T., M. Maclachlan (1988). Occupational Sex Segregation - Increasing or Decreasing? 
        Economic Record, vol. 64, no. 3, pp. 187-195. <a href="https://doi.org/10.1111/j.1475-4932.1988.tb02057.x" 
        class="uri">doi:10.1111/j.1475-4932.1988.tb02057.x</a></p>
    </div>    
</body>
</html>