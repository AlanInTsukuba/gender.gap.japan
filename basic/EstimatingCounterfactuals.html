<html>
    <head>
      <!--<meta name="google-site-verification" content="Z7SEnQaO9LAITbhuwGaI3rFtnpMRKeV9BbaW3LyvP2g" />-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="revised" content="30 March 2022" />
        <title>Drill down: A. Specialists and technicians - Estimating counterfactuals following Deming and Stephan (1940)</title>

        <!--<link rel="stylesheet" href="https://latex.now.sh/style.css"> -->
        <link rel="stylesheet" href="https://alanintsukuba.github.io/latex.css">
        <link rel="stylesheet" href="https://alanintsukuba.github.io/ShowReferencesModal.css"> 
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" 
integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" 
integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]-->    
</head>
<body>
    <h1>Drill down: A. Specialists and technicians - Estimating counterfactuals following Deming and Stephan (1940)</h1>
    <p class="author"><a href="https://orcid.org/0000-0003-0070-2347" target="_blank">Alan Engel</a><br>Last update: 
        30 March 2022</p>
    <main>
        <article>
        <h4>Estimating counterfactuals following <a href="#DemingStephan1940">Deming and Stephan (1940)</a></h4>
        <p> This procedure adjusts sampled frequency tables when the expected marginal totals are known. In this case, 
        we want to adjust the gender vs occupation table for 1985 to that which would be expected for 2005 marginal 
    totals assuming no structural changes. The difference in M between the 2005 actual and the counterfactual frequency 
    values is the structural change and the difference in M between the counterfactual and the 1985 actual 
    frequency values is the marginal change. Below I manually calculate the counterfactual frequencies and M decompositions 
    following Elbers's method.</p>
    <p>Elbers uses Deming and Stephan's iterative procedure for estimating the counterfacturals. In their 1940 paper, 
        Deming and Stephan also provide a direct method; I use the direct method in this task. First, I compress the 
        spectech occupation group into 3 occupations: judges and lawyers; other legal; and other spectech. The 
        calculated total M indexes will differ from the uncompressed case because M is dependent on the number of 
        occupations, but the estimated counterfactual frequencies for the legal occupations of interest will not differ 
        from the uncompressed case.
    </p>
    <table class="noincrement" style="counter-increment: null;">
        <caption class="noincrement"><b>Table 1. </b>Actual occupation vs gender frequencies for legal occupations in 1985 and 2005</caption>
        <tr><th></th><th colspan=3>1985</th><th></th><th colspan=3>2005</th></tr>
        <tr><td></td><td colspan=2>Gender</td><td></td><td></td><td colspan=2>Gender</td></tr>
        <tr><td>Occupation</td><td>Female</td><td>Male</td><td>Marginal total</td><td></td><td>Female</td><td>Male</td><td>Marginal total</td></tr>
        <tr><td>Judges, lawyers</td><td>789</td><td>15204</td><td>15993</td><td></td><td>2302</td><td>19506</td><td>21808</td></tr>
        <tr><td>Other legal</td><td>2795</td><td>23926</td><td>26721</td><td></td><td>6379</td><td>29833</td><td>36212</td></tr>
        <tr><td>Other spectech</td><td>2555759</td><td>3789332</td><td>6345091</td><td></td><td>4018698</td><td>4465215</td><td>8483913</td></tr>
        <tr><td>Marginal total</td><td>2559343</td><td>3828462</td><td>6387805</td><td></td><td>4027379</td><td>4514554</td><td>8541933</td></tr>
    </table>
    <p>Deming and Stephan (1940) estimate the cell frequencies \(N_{ij}\) of an <i>r \(\times\) s</i> universe table  
        based on the cell frequencies \(n_{ij}\)
    of an <i>r \(\times\) s</i> sampled table when the expected marginal totals of the universe table are known. For the 
    two-dimensional case, we seek the values of <i>\(m_{ij}\)</i> that minimize 
    $$\tag{3}S = \sum\frac{(m_{ij}-n_{ij})^2}{n_{ij}}$$ where I number the equations as in Deming and Stephan (1940). 
    Following their <i>Case II: Both sets of marginal totals known</i>, assume \(N_{1.}, N_{2.}, \cdots, N_{r.}\) to be 
    known. We require $$\tag{4}\sum_{j}m_{ij} = m_{i.},\hspace{60pt} i = 1, 2, \cdots, r.$$ (from Case I) and 
    $$\tag{5}\sum_{i}m_{ij} = m_{.j},\hspace{60pt} j = 1, 2, \cdots, s-1.$$conditions on the 
    adjusted \(m_{ij}\), a total of \(r+s-1\) conditions. For both cases, $$\tag{6}m_{i.}=N_{i.}n/N,$$
    $$\tag{7}m_{.j}=N_{.j}n/N.$$ In other words, \(m_{i.}\) and \(m_{.j}\) are the deflated marginal totals, 
    \(N_{i.}\) and \(N_{.j}\) divided by the actual sampling ratio \(N/n\).</p>
    <p><i>Solution.</i> Assuming that the adjusted values of the \(m_{ij}\) have been found, let each take on a 
    small variation \(\delta m_{ij}\); then the differentials of eqs. (3), (4) and (5) give 
    $$\tag{10}\frac{1}{2}\delta S=\sum \{(m_{ij}-n_{ij})/n_{ij}\}\delta m_{ij}=0 \hspace{20pt} \verb!(one equation),!$$ 
    $$\tag{11}\sum_{j} \delta m_{ij} = 0,\hspace{40pt} i = 1, 2, \cdots, r, \hspace{20pt} \verb!(r equations)!$$
    (eqs. (10) and (11) being shared with Case I)
    $$\tag{17}\sum_{i} \delta m_{ij} = 0,\hspace{40pt} j = 1, 2, \cdots, s-1, \hspace{20pt} \verb!(s-1 equations)!.$$ 
    By adding eqs. (10), (11) and (17), after multiplying eq. (11<i>i</i>) by the Lagrange multiplier \(-\lambda_{i.}\) and eq. (17<i>j</i>) 
    by \(-\lambda_{.j}\), we get 
    $$\tag{18} \sum \{(m_{ij}-n_{ij})/n_{ij}-\lambda_{i.}-\lambda_{.j}\} \delta m_{ij}= 0.$$
    Equating each brace to zero, we get
    $$\tag{19} m_{ij}=n_{ij}(1+ \lambda_{i.} + \lambda_{.j})$$ wherein \(\lambda_{.s}\) is to be counted 0.</p>
    <p>To evaluate the Lagrange multipliers in eq. (19), we sum the two members down and across the tables to obtain 
        the \(r+s-1\) normal equations
    $$ \tag{20} n_{i.} \lambda_{i.} + \sum_{j}n_{ij}\lambda_{.j} = m_{i.}-n_{i.}, \hspace{40pt} i = 1, 2, \cdots, r  \\
    \sum_{i} n_{ij} \lambda_{i.} + n_{.j} \lambda_{.j}  = m_{.j}-n_{.j}, \hspace{40pt} j = 1, 2, \cdots, s-1. $$
    </p>
    <p>The top row of eqs (20) solved for \(\lambda_{i.}\) gives 
    $$\tag{21} \lambda_{i.} = (1/n_{i.})\{m_{i.} - \sum_{j} n_{ij}\lambda_{.j} \} - 1.$$
    Substituted into the bottom row of eqs. (20), this gives the \(s - 1 \) normal equations.
    </p>
    <table class="noincrement">
        <tr><td style="text-align:center">\(\lambda_{.1}\)</td>
            <td style="text-align:center">\(\lambda_{.2}\)</td>
            <td style="text-align:center">\(...\)</td>
            <td style="text-align:center">\(\lambda_{.s-1}\)</td>
            <td style="text-align:center">\(=\)</td>
            <td>\(1\)</td></tr>
        <tr><td style="text-align:center">\(n_{.1}-\sum_{i}\frac{n_{i1}n_{i1}}{n_{i.}} \)</td>
            <td style="text-align:center">\(-\sum_{i}\frac{n_{i1}n_{i2}}{n_{i.}} \)</td>
            <td style="text-align:center">\(...\)</td>
            <td style="text-align:center">\(-\sum_{i}\frac{n_{i1}n_{i,s-1}}{n_{i.}} \)</td>
            <td style="text-align:center">\(=\)</td>
            <td>\(m_{.1}-\sum_{i}\frac{n_{i1}m_{i.}}{n_{i.}} \)</td></tr>
        <tr><td style="text-align:center"></td>
            <td style="text-align:center">\(n_{.2}-\sum_{i}\frac{n_{i2}n_{i2}}{n_{i.}} \)</td>
            <td style="text-align:center">\(...\)</td>
            <td style="text-align:center">\(-\sum_{i}\frac{n_{i2}n_{i,s-1}}{n_{i.}} \)</td>
            <td style="text-align:center">\(=\)</td>
            <td>\(m_{.2}-\sum_{i}\frac{n_{i2}m_{i.}}{n_{i.}} \)</td>
        </tr>
        <tr>
            <td>\((22)\)</td>
            <td></td>
            <td></td>
            <td style="text-align:center">\(.\)<br>\(.\)<br>\(.\)</td>
            <td></td>
            <td style="text-align:center">\(.\)<br>\(.\)<br>\(.\)</td>
        </tr>
        <tr><td style="text-align:center"></td>
            <td style="text-align:center"></td>
            <td style="text-align:center"></td>
            <td style="text-align:center">\(n_{.s-1}-\sum_{i}\frac{n_{i,s-1}n_{i,s-1}}{n_{i.}} \)</td>
            <td style="text-align:center">\(=\)</td>
            <td>\(m_{.s-1}-\sum_{i}\frac{n_{i,s-1}m_{i.}}{n_{i.}} \)</td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>\(0.\)</td>
        </tr>
        </table>
    <p>The coefficients are symmetrical and those below the diagonal are omitted. Deming and Stephan (1940) add the 0 in the bottom row 
        to enable computation of the minimized S. The Lagrange multipliers are then solved, \(s-1\) directly and the remaining by 
        substitution into eq. (21), with \(\lambda_{.s}\) being set to 0.
    </p>
    <table class="noincrement">
        <caption class="noincrement"><b>Table 2. </b>A table showing the counterfactuals of the numbers of females and males in the occupational categories judges and lawyers, other legal, and other spectech from 
            the 1985 Population Census as computed for the 2005 Population Census
    <br>(TABLE 1 from Deming and Stephan (1940) adapted for this task)</caption>
        <tr style="border: 1px solid black;"><td colspan=3>Gender</td><td>Female</td><td>Male</td></tr>
        <tr style="border: 1px solid black;"><td colspan=3 style="text-align: right">j =</td><td>1</td><td>2</td><td>\(n_{i.}\)</td></tr>
        <tr style="border: 1px solid black;"><td colspan=3 style="text-align: right">\(\lambda_{.i}\) =</td><td>0.3966</td><td>0</td><td>\(m_{i.}\)</td></tr>
        <tr style="border: 1px solid black;"><td>Occupation</td><td style="text-align: center">i</td><td style="text-align: center">\(\lambda_{i.}\)</td></tr>
        <tr style="border: 1px solid black;"><td rowspan=2>Judges, lawyers</td><td rowspan=2>1</td><td>0.3440</td><td>789</td><td>15204</td><td>15993</td></tr>
        <tr style="border: 1px solid black;"><td></td><td><i>1373</i></td><td><i>20434</i></td><td><i>21808</i></td></tr>
        <tr style="border: 1px solid black;"><td rowspan=2>Other legal</td><td rowspan=2>2</td><td>0.3137</td><td>2795</td><td>23926</td><td>26721</td></tr>
        <tr style="border: 1px solid black;"><td></td><td><i>4780</i></td><td><i>31432</i></td><td><i>36212</i></td></tr>
        <tr style="border: 1px solid black;"><td rowspan=2>Other spectech</td><td rowspan=2>3</td><td>0.1772</td><td>2555759</td><td>3789332</td><td>6345091</td></tr>
        <tr style="border: 1px solid black;"><td></td><td><i>4022254</i></td><td><i>4460802</i></td><td><i>8482913</i></td></tr>
        <tr style="border: 1px solid black;"><td></td><td></td><td style="text-align: center">\(n_{.i}\)</td><td>2559343</td><td>3828462</td><td>6387805</td></tr>
        <tr style="border: 1px solid black;"><td></td><td></td><td style="text-align: center">\(m_{.i}\)</td><td><i>4027379</i></td><td><i>4514554</i></td><td><i>8541933</i></td></tr>
    </table>
    <p>For computations using the machines of the day, Deming and Stephan (1940) set up a preparatory table, which I adapt in Table 3, 
        by dividing each \(n_{ij}\) in the <i>i</i>th row by \(\sqrt{n_{i.}}\) and also calculating \(m_{i.}/\sqrt{n_{i.}}\) for that row. </p>
    <p>The numerical example in Deming and Stephan (1940) uses an artificial sample of native white persons if native white parentage 
        attending school in 6 states by 4 age brackets. The sample in this task is for 3 occupations and 2 genders.
    </p>
    <p>
        For this task, I estimate the counterfactuals gender counts for the 2005 census using the actual occupation vs gender counts 
        for 1985 and the marginal totals for 2005. To illustrate, for \(i=1\) and \(j=1\), \(789/\sqrt{15993} = 6.24\). Summing the squares 
        and cross-products along the vertical gives the summations for eqs. (22), which are given below as eqs. (23).
    </p>
    <table class="noincrement">
        <tr>
            <td>No.</td>
            <td style="text-align:center">\(\lambda_{.1}\)</td>
            <td style="text-align:center">\(=\)</td>
            <td>\(1\)</td>
            <td></td>
        </tr>
        <tr>
            <td>1</td>
            <td style="text-align:center">1525994</td>
            <td style="text-align:center">\(=\)</td>
            <td>605268</td>
            <td>(23)</td>
        </tr>
        <tr>
            <td>2</td>
            <td style="text-align:center"></td>
            <td style="text-align:center"></td>
            <td>0</td>
            <td></td>
        </tr>
    </table>
    <p>Solving eqs. (23) gives \(\lambda_{.1} = 0.3966\). Substitution into eq. (21) gives eqs. (24).
        $$\tag{24} \lambda_{1.} = 0.3440\text{, }\lambda_{2.} = 0.3137\text{ and }\lambda_{3.} = 0.1772 $$
        The \(m_{ij}\) can then be computed by eq. (19), for example, 
        $$\tag{25} m_{21}=2795(1+0.3966+0.3137) = 4780 $$
    </p>
    <table class="noincrement">
        <caption class="noincrement"><b>Table 3. </b>Preparatory TABLE 2 from Deming and Stephan (1940) adapted for this task</caption>
        <tr><td></td><td colspan=2 style="text-align: center">j =</td><td style="text-align: center">\(m_{i.}/\sqrt{n_{i.}}\)</td><td style="text-align: center">Sum</td></tr>
        <tr><td>i</td><td>1</td><td>2</td></tr>
        <tr><td>1</td><td>6.239</td><td>120.22</td><td>172.45</td><td>298.91</td></tr>
        <tr><td>2</td><td>17.10</td><td>146.37</td><td>221.53</td><td>384.99</td></tr>
        <tr><td>3</td><td>1014.61</td><td>1504.33</td><td>3368.04</td><td>5886.99</td></tr>
        <tr><td>Sum</td><td>1037.95</td><td>1770.92</td><td>3762.01</td><td>6570.89</td></tr>
    </table>
    <p>We can use the counterfactuals (\(m_{ij}\)) in Table 4 to interpret the actual frequencies for 2005 as listed 
        in Table 1. Women employed as judges and lawyers increased from 789 in 1985 to 2302 in 2005, a 192% increase. 
        Of this 1513-person increase, 584 (74%) can be assigned to marginal changes; both the numbers of women in spectech 
        and the number of people employed as judges and lawyers increased. The remaining 929 can be attributed to structural 
        changes in this occupation. This structural gain in 929 women judges and lawyers is mirrored by a 929-person shortfall versus 
        marginal changes for men (19506 actual versus 20434 expected). Other legal occupations, such as scriveners and patent agents, 
        also showed structural gains for women, a 228 percent gain to 6379 actual versus the 4780 expected from marginal increases.
    </p>
    </article>
    <article>
        <h2>Note on using R to solve normalized equations (23) in Deming and Stephan (1940)</h2>
        <p>Equations (23) in this task have a trivial solution. Deming and Stephan (1940) contains a less 
            trivial example of 3 equations with 3 unknowns. The code below shows a way of solving 
            those equations using R.
        </p>
<pre><code class="language-html"># DemingStephanMatrix.R
#
# Solve equations (23) in Deming, W. E., and Frederick F. Stephan. (1940) "On a Least Squares Adjustment of a Sampled Frequency 
#        Table when the Expected Marginal Totals are Known." 
#        The Annals of Mathematical Statistics, vol. 11, no. 4, pp. 427-444.
#
# Reference:
# https://cran.r-project.org/web/packages/matlib/vignettes/linear-equations.html
#
# If not yet installed
install.packages("matlib")

# load library
library(matlib)

citation("matlib")
#  Michael Friendly, John Fox and Phil Chalmers (2021). matlib: Matrix Functions
#  for Teaching and Learning Linear Algebra and Multivariate Statistics. R package
#  version 0.9.5. https://CRAN.R-project.org/package=matlib

A <- matrix(c(7413, -3549, -2354,
        -3549, 4441, -544,
        -2354, -544, 3129), 3, 3, byrow=TRUE)
colnames(A) <- paste0('x', 1:3)
b <- c(31.97, 23.56, -32.22)
showEqn(A,b)

##   7413*x1 - 3549*x2 - 2354*x3  =   31.97 
##  -3549*x1 + 4441*x2  - 544*x3  =   23.56 
##  -2354*x1  - 544*x2 + 3129*x3  =  -32.22 

# Are the equations consistent?
c( R(A), R(cbind(A,b)) )  # show ranks

##  [1] 3 3

all.equal( R(A), R(cbind(A,b)) ) # consistent?

##  [1] TRUE

# Solve for X.

solve(A,b)

##           x1          x2          x3 
##  0.011822067 0.014898033 0.001186857 

solve(A) %*% b

##            [,1]
##  x1 0.011822067
##  x2 0.014898033
##  x3 0.001186857

# clean up
rm(A,b)
</code></pre>
    </article>
</main>
<div id="references" class="section level2">
    <h2 class="hasAnchor">
    <a href="#references" class="anchor"></a>References</h2>
    <p><a id="DemingStephan1940"></a>Deming, W. E., and Frederick F. Stephan. (1940) "On a Least Squares Adjustment of a Sampled Frequency 
        Table when the Expected Marginal Totals are Known." 
        The Annals of Mathematical Statistics, vol. 11, no. 4, pp. 427-444. 
    <a href="https://www.jstor.org/stable/2235722">https://www.jstor.org/stable/2235722</a></p>
    <p><a id="Elbers2021"></a>Elbers, Benjamin (2021). A Method for Studying Differences in Segregation Across Time and Space. 
        Sociological Methods &amp; Research. <a href="https://doi.org/10.1177/0049124121986204" 
        class="uri">doi:10.18637/jss.v089.i07</a></p>
    </div>    
</body>
</html>