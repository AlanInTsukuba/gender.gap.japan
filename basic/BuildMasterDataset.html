<!DOCTYPE html>
<html>
    <head>
      <!--<meta name="google-site-verification" content="Z7SEnQaO9LAITbhuwGaI3rFtnpMRKeV9BbaW3LyvP2g" />-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="revised" content="3 December 2021" />
        <title>Build master dataset</title>

        <link rel="stylesheet" href="https://latex.now.sh/style.css"> 
        <link rel="stylesheet" href="https://alanintsukuba.github.io/ShowReferencesModal.css"> 
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" 
integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" 
integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]-->    
</head>
<body>
<h1>Build master dataset</h1>
<p class="author"><a href="https://orcid.org/0000-0003-0070-2347" target="_blank">Alan Engel</a><br>Last update: 
3 December 2021</p>
<main>
<p>The following R script builds the master occupation-gender dataset from the table of harmonized 
    occupation classifications and occupation-gender files downloaded from e-Stat and preprocessed.
</p>
<p>This script is saved in <a href="https://github.com/AlanInTsukuba/tsukuba.segregation/tree/main/basic/R">the 
    repository</a> for this project. The datasets used in this script and produced by it are also in 
    <a href="https://github.com/AlanInTsukuba/tsukuba.segregation/tree/main/basic/data">the repository</a>.
</p>
<pre><code class="language-html">#' UchikoshiMugiyamaRepro01.R
    #' Reproduce analysis of Uchikoshi and Mugiyama using data 
    #' 	prepared as described at 
    #' 	https://alanintsukuba.github.io/tsukuba.segregation/
    #' Uchikoshi, Fumiya, Ryota Mugiyama. Trends in Occupational Sex Segregation 
    #' 	in Japan: A Decomposition Analysis of Census Data, 1980-2005. 
    #' 	Japanese Journal of Population Studies. 2020. 56. 9-23 
    #' 	https://doi.org/10.24454/jps.1901001
    
    #' install.packages("openxlsx")
    library(openxlsx)
    
    #' Load and look at harmonized occupation classes
    hoc <- read.csv("....HarmonizedOccupationClasses1985-2005.csv",header=T)
    head(hoc)
    
    #'   OccMain OccSub OccMid OccMinor   X1985   X1990   X1995   X2000   X2005
    #' 1       A     10    101     1001 1985001 1990001 1995001 2000001 2005001
    #' 2       A     10    101     1002 1985002 1990002 1995002 2000002 2005002
    #' 3       A     10    102     1003 1985010 1990003 1995003 2000003 2005003
    #' 4       A     10    102     1004 1985003 1990004 1995004 2000004 2005004
    #' 5       A     10    102     1004 1985004      NA      NA      NA      NA
    #' 6       A     10    102     1005 1985005 1990005 1995005 2000005 2005005
    #'                          MainTitle                  MidTitle
    #' 1 SPECIALIST AND TECHNICAL WORKERS       SCIENCE RESEARCHERS
    #' 2                                                           
    #' 3                                                           
    #' 4                                  ENGINEERS AND TECHNICIANS
    #' 5                                                           
    #' 6                                                           
    #'                                                   MinorTitle
    #' 1                                 Natural science researchers
    #' 2                      Humanities, social science researchers
    #' 3       Agriculture, forestry, fisheries and food technicians
    #' 4                                  Metal smelting technicians
    #' 5                                                        <NA>
    #' 6 Mechanical engineers, aircraft and shipbuilding technicians
    
    #' Load and look at minor occupation totals from 1985
    mot <- read.xlsx("....1985_totals_minor_occupations.xlsx","Extract")
    head(mot)
    
    #'   OccCode Gender  value
    #' 1 1985001   MALE  86322
    #' 2 1985002   MALE   2850
    #' 3 1985003   MALE   3926
    #' 4 1985004   MALE  25909
    #' 5 1985005   MALE 284513
    #' 6 1985006   MALE 307559
    
    # add census year column to mot 
    mot$CensusYear <- 1985
    
    #' merge on X1985 and OccCode columns
    occgencomb <- merge(hoc[,c("OccMain","OccSub","OccMid","OccMinor","X1985")],
        mot, by.x="X1985",by.y="OccCode")
    head(occgencomb)
    #' remove X1985 column
    occgencomb <- occgencomb[,-1]
    #' remove NA rows
    occgencomb <- na.omit(occgencomb)
    
    #' aggregate: sum values by grouping on all other columns
    occgencomb <- aggregate(occgencomb$value, 
        list(OccMain=occgencomb$OccMain,
             OccSub=occgencomb$OccSub, 
            OccMid=occgencomb$OccMid,
             OccMinor=occgencomb$OccMinor,
            Gender=occgencomb$Gender,
            CensusYear=occgencomb$CensusYear),
        FUN="sum")
    #' aggregate names the aggregated column 'x'. Return it to 'value'.
    colnames(occgencomb) <- c("OccMain","OccSub","OccMid","OccMinor","Gender","CensusYear","value")
    
    ## put occgencomb in a master occgenall data frame
    occgenall <- occgencomb
    
    ####################################################
    # repeat with 1990 data and append
    #' Load and look at minor occupation totals from 1990
    mot <- read.xlsx("....1990_totals_minor_occupations.xlsx","Extract")
    head(mot)
    mot$CensusYear <- 1990
    #' merge on X1990 and OccCode columns
    occgencomb <- merge(hoc[,c("OccMain","OccSub","OccMid","OccMinor","X1990")],
        mot, by.x="X1990",by.y="OccCode")
    #' remove X1990 column
    occgencomb <- occgencomb[,-1]
    #' remove NA rows
    occgencomb <- na.omit(occgencomb)
    #' aggregate: sum values by grouping on all other columns
    occgencomb <- aggregate(occgencomb$value, 
        list(OccMain=occgencomb$OccMain,
             OccSub=occgencomb$OccSub, 
            OccMid=occgencomb$OccMid,
             OccMinor=occgencomb$OccMinor,
            Gender=occgencomb$Gender,
            CensusYear=occgencomb$CensusYear),
        FUN="sum")
    colnames(occgencomb) <- c("OccMain","OccSub","OccMid","OccMinor","Gender","CensusYear","value")
    
    occgenall <- rbind(occgenall,occgencomb)
    
    ####################################################
    # repeat with 1995 data and append
    #' Load and look at minor occupation totals from 1995
    mot <- read.xlsx("....1995_totals_minor_occupations.xlsx","Extract")
    head(mot)
    mot$CensusYear <- 1995
    #' merge on X1995 and OccCode columns
    occgencomb <- merge(hoc[,c("OccMain","OccSub","OccMid","OccMinor","X1995")],
        mot, by.x="X1995",by.y="OccCode")
    #' remove X1995 column
    occgencomb <- occgencomb[,-1]
    #' remove NA rows
    occgencomb <- na.omit(occgencomb)
    #' aggregate: sum values by grouping on all other columns
    occgencomb <- aggregate(occgencomb$value, 
        list(OccMain=occgencomb$OccMain,
             OccSub=occgencomb$OccSub, 
            OccMid=occgencomb$OccMid,
             OccMinor=occgencomb$OccMinor,
            Gender=occgencomb$Gender,
            CensusYear=occgencomb$CensusYear),
        FUN="sum")
    colnames(occgencomb) <- c("OccMain","OccSub","OccMid","OccMinor","Gender","CensusYear","value")
    occgenall <- rbind(occgenall,occgencomb)
    
    ####################################################
    # repeat with 2000 data and append
    #' Load and look at minor occupation totals from 2000
    mot <- read.xlsx("....2000_totals_minor_occupations.xlsx","Extract")
    head(mot)
    mot$CensusYear <- 2000
    #' merge on X2000 and OccCode columns
    occgencomb <- merge(hoc[,c("OccMain","OccSub","OccMid","OccMinor","X2000")],
        mot, by.x="X2000",by.y="OccCode")
    #' remove X2000 column
    occgencomb <- occgencomb[,-1]
    #' remove NA rows
    occgencomb <- na.omit(occgencomb)
    #' aggregate: sum values by grouping on all other columns
    occgencomb <- aggregate(occgencomb$value, 
        list(OccMain=occgencomb$OccMain,
             OccSub=occgencomb$OccSub, 
            OccMid=occgencomb$OccMid,
             OccMinor=occgencomb$OccMinor,
            Gender=occgencomb$Gender,
            CensusYear=occgencomb$CensusYear),
        FUN="sum")
    colnames(occgencomb) <- c("OccMain","OccSub","OccMid","OccMinor","Gender","CensusYear","value")
    occgenall <- rbind(occgenall,occgencomb)
    
    ####################################################
    # repeat with 2005 data and append
    #' Load and look at minor occupation totals from 2005
    mot <- read.xlsx("....2005_totals_minor_occupations.xlsx","Extract")
    head(mot)
    mot$CensusYear <- 2005
    #' merge on X2005 and OccCode columns
    occgencomb <- merge(hoc[,c("OccMain","OccSub","OccMid","OccMinor","X2005")],
        mot, by.x="X2005",by.y="OccCode")
    #' remove X2005 column
    occgencomb <- occgencomb[,-1]
    #' remove NA rows
    occgencomb <- na.omit(occgencomb)
    #' aggregate: sum values by grouping on all other columns
    occgencomb <- aggregate(occgencomb$value, 
        list(OccMain=occgencomb$OccMain,
             OccSub=occgencomb$OccSub, 
            OccMid=occgencomb$OccMid,
             OccMinor=occgencomb$OccMinor,
            Gender=occgencomb$Gender,
            CensusYear=occgencomb$CensusYear),
        FUN="sum")
    colnames(occgencomb) <- c("OccMain","OccSub","OccMid","OccMinor","Gender","CensusYear","value")
    occgenall <- rbind(occgenall,occgencomb)
    
    #######################################################
    #' occgenall is the completed full dataset. Save it as an 
    #' R object
    saveRDS(occgenall, file="....occgenall.Rda")
    
    write.table(occgenall, file="....occgenall.csv", sep="\t",row.names=F)
    
    #################################
    #' clean up
    ls()
    rm("hoc","mot","mot1985","occgen", "occgencomb")
    </code></pre>    
</main>
</body>
</html>
